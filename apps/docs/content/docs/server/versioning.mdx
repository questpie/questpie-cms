---
title: Versioning
description: Automatic version history, rollback, and audit trails for collection records
---

# Versioning

QUESTPIE can automatically create version snapshots every time a record is created, updated, or deleted. This gives you a complete audit trail and the ability to revert records to any previous state.

## Why This Exists

Content management often requires an audit trail — who changed what, when, and the ability to undo mistakes. QUESTPIE's versioning system stores complete record snapshots in a dedicated versions table, letting you browse history and revert with a single API call.

## Enabling Versioning

Add `versioning: true` to the collection's `.options()`:

```ts
export const posts = qb
  .collection("posts")
  .fields((f) => ({
    title: f.text({ required: true }),
    content: f.richText({}),
    status: f.select({ options: ["draft", "published", "archived"] }),
  }))
  .options({
    timestamps: true,
    versioning: true,
  });
```

### Configuration

```ts
.options({
  versioning: {
    enabled: true,
    maxVersions: 100,  // Keep last 100 versions per record (default: 50)
  },
})
```

| Option | Type | Default | Description |
|---|---|---|---|
| `enabled` | `boolean` | `false` | Enable version tracking |
| `maxVersions` | `number` | `50` | Maximum versions to keep per record. Oldest are pruned automatically. |

## How It Works

```text
CRUD operation → [normal hooks + DB write] → createVersionRecord() → [prune old versions]
```

When versioning is enabled:

1. Every create, update, and delete operation creates a version record
2. The version record contains a complete snapshot of the record at that point
3. For localized collections, i18n data is also versioned in a separate i18n versions table
4. Old versions are automatically pruned when `maxVersions` is exceeded

## Version Record Structure

Each version contains:

| Field | Type | Description |
|---|---|---|
| `id` | `string` | Original record ID (foreign key) |
| `versionId` | `string` | Unique ID for this version (UUID) |
| `versionNumber` | `number` | Sequential version number (1, 2, 3...) |
| `versionOperation` | `string` | `"create"`, `"update"`, or `"delete"` |
| `versionUserId` | `string \| null` | User who made the change (from session) |
| `versionCreatedAt` | `Date` | When this version was created |
| _...all record fields_ | _varies_ | Complete snapshot of all field values |

## Generated Tables

When you enable versioning, QUESTPIE auto-generates:

- **`{collection}_versions`** — Version records with all main table columns plus version metadata
- **`{collection}_i18n_versions`** — Localized field versions (if the collection has localized fields)

## API

### Finding Versions

Retrieve the version history for a record:

```ts
const versions = await cms.api.collections.posts.findVersions({
  id: "post-123",
  limit: 10,
  offset: 0,
});

// versions: Array<{
//   versionId: string;
//   versionNumber: number;
//   versionOperation: "create" | "update" | "delete";
//   versionUserId: string | null;
//   versionCreatedAt: Date;
//   title: string;
//   content: any;
//   status: string;
//   ...
// }>
```

### Reverting to a Version

Restore a record to a previous version:

```ts
// Revert by version number
await cms.api.collections.posts.revertToVersion({
  id: "post-123",
  versionNumber: 3,
});

// Revert by version ID
await cms.api.collections.posts.revertToVersion({
  id: "post-123",
  versionId: "version-uuid-here",
});
```

Reverting:
1. Reads the specified version record
2. Restores all field values to the main table
3. Restores localized fields to the i18n table (if applicable)
4. Creates a new version recording the revert operation
5. Runs `beforeChange` and `afterChange` hooks
6. Enforces update access control

### Localized Versions

For collections with localized fields, `findVersions` supports locale-specific queries:

```ts
const versions = await cms.api.collections.posts.findVersions(
  { id: "post-123" },
  { locale: "de" },
);
```

This returns versions with localized field values merged from the i18n versions table, with fallback to the default locale.

## Transaction Behavior

Version creation runs inside the same transaction as the CRUD operation. If the operation fails and rolls back, no version is created. If the version creation fails, the entire operation rolls back.

## Automatic Pruning

When a record exceeds `maxVersions`, the oldest versions are automatically deleted:

```text
Record has 50 versions + new version = 51
→ Delete version #1 (oldest)
→ Now 50 versions remain
```

This happens inside the same transaction as the version creation.

## Common Mistakes

- **Versioning high-frequency collections** — Collections with frequent writes (analytics, logs) can accumulate many version records. Set a low `maxVersions` or skip versioning entirely for these.
- **Large `richText` or `blocks` fields** — Each version stores a complete snapshot. Large content fields multiply storage requirements. Consider `maxVersions` limits.
- **Not checking `versionOperation`** — When browsing versions, filter by `versionOperation` to distinguish creates, updates, and deletes.

## Related Pages

- [Collections](/docs/server/collections) — Collection `.options()` configuration
- [Context & Transactions](/docs/server/context-and-transactions) — Transaction behavior
- [Hooks & Lifecycle](/docs/server/hooks-and-lifecycle) — Hooks run during revert operations
- [Database & Migrations](/docs/infrastructure/database-and-migrations) — Auto-generated version tables
