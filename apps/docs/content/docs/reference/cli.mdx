---
title: CLI Reference
description: Complete reference for the QUESTPIE command-line interface.
---

QUESTPIE provides a CLI tool (`questpie`) for database migrations and schema management. The CLI uses your app configuration to generate and run migrations.

## Installation

The CLI is included with `questpie`. To use it, add a script to your `package.json`:

```json
{
  "scripts": {
    "questpie": "bun --bun ./node_modules/questpie/dist/cli/index.js"
  }
}
```

Or run directly:

```bash
bun ./node_modules/questpie/dist/cli/index.js migrate:generate
```

## Configuration

The CLI looks for `questpie.config.ts` in the current directory by default. Use `q.config` for type-safe configuration:

```typescript
// questpie.config.ts
import { q } from "questpie";
import { app } from "./src/server/app";

export default q.config({
  app: app,
  cli: {
    migrations: {
      directory: "./src/migrations", // Where to save generated migrations
    },
  },
});
```

The config has two parts:

- **`app`** - Your QUESTPIE app instance (required)
- **`cli`** - CLI-specific settings (optional)

### Migration Loading

Migrations are loaded from the app instance via `.migrations([...])`, not from the directory. The directory is only used for saving newly generated migrations.

```typescript
// src/server/app.ts
import { migrations } from "../migrations";

export const app = q({ name: "my-app" })
  .collections({ posts })
  .migrations(migrations)  // Load migrations here
  .build({ ... });
```

## Migration Commands

### migrate:generate

Generate a new migration from schema changes.

```bash
bun questpie migrate:generate
bun questpie migrate:generate --name add-posts-table
bun questpie migrate:generate --dry-run
```

**What it does:**

1. Loads your app config and schema via `app.getSchema()`
2. Compares with previous schema snapshots in `cli.migrations.directory/snapshots/`
3. Generates a migration file with `up()` and `down()` functions
4. Updates `migrations/index.ts` with the new migration
5. You then import and add it to `.migrations([...])` in your app

**Options:**

| Option                | Description                                                     |
| --------------------- | --------------------------------------------------------------- |
| `-c, --config <path>` | Path to config file (default: `questpie.config.ts`)             |
| `-n, --name <name>`   | Custom migration name (default: random like `happy_blue_panda`) |
| `--dry-run`           | Preview without creating files                                  |
| `--verbose`           | Show detailed output                                            |

**Example output:**

```
ğŸ“ Generating migration...

ğŸ“Š Loaded schema with 12 definitions
ğŸ“ Migration name: 20240115T143022_add_posts_table
ğŸ”¤ Variable name: addPostsTable20240115T143022

ğŸ“ Updated migrations index: ./migrations/index.ts

âœ… Migration generated successfully!

Next steps:
  1. Review the migration file: ./src/migrations/20240115T143022_add_posts_table.ts
  2. Import migrations in your app: .migrations(migrations)
  3. Run migrations: bun questpie migrate:up
```

**Generated migration structure:**

```typescript
// migrations/20240115T143022_add_posts_table.ts
import type { Migration } from "questpie";

export const addPostsTable20240115T143022: Migration = {
  id: "20240115T143022_add_posts_table",
  up: async (db) => {
    await db.execute(`
      CREATE TABLE "posts" (
        "id" uuid PRIMARY KEY DEFAULT gen_random_uuid(),
        "title" varchar(255) NOT NULL,
        "content" text,
        "created_at" timestamp DEFAULT now(),
        "updated_at" timestamp DEFAULT now()
      )
    `);
  },
  down: async (db) => {
    await db.execute(`DROP TABLE IF EXISTS "posts"`);
  },
};
```

---

### migrate:up

Run pending migrations.

```bash
bun questpie migrate:up
bun questpie migrate:up --target 20240115T143022_add_posts_table
bun questpie migrate:up --dry-run
```

**Options:**

| Option                     | Description                                         |
| -------------------------- | --------------------------------------------------- |
| `-c, --config <path>`      | Path to config file (default: `questpie.config.ts`) |
| `-t, --target <migration>` | Run up to (and including) specific migration ID     |
| `--dry-run`                | Show what would be run without executing            |

**Example:**

```bash
# Run all pending migrations
bun questpie migrate:up

# Run up to specific migration
bun questpie migrate:up --target 20240115T143022_add_posts_table
```

---

### migrate:down

Rollback migrations.

```bash
bun questpie migrate:down
bun questpie migrate:down --batch 2
bun questpie migrate:down --target 20240115T143022_add_posts_table
```

**Behavior:**

- Without options: Rolls back the last batch of migrations
- With `--batch`: Rolls back migrations from a specific batch number
- With `--target`: Rolls back to (but not including) a specific migration

**Options:**

| Option                     | Description                                         |
| -------------------------- | --------------------------------------------------- |
| `-c, --config <path>`      | Path to config file (default: `questpie.config.ts`) |
| `-b, --batch <number>`     | Rollback specific batch number                      |
| `-t, --target <migration>` | Rollback to specific migration                      |
| `--dry-run`                | Show what would be run without executing            |

**Example:**

```bash
# Rollback last batch
bun questpie migrate:down

# Rollback batch #2
bun questpie migrate:down --batch 2

# Rollback to specific migration (excludes target)
bun questpie migrate:down --target 20240110T120000_initial
```

---

### migrate:status

Show migration status.

```bash
bun questpie migrate:status
```

**Options:**

| Option                | Description                                         |
| --------------------- | --------------------------------------------------- |
| `-c, --config <path>` | Path to config file (default: `questpie.config.ts`) |

**Example output:**

```
ğŸ“¦ Found 5 migrations

Migration Status:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ID                                          â”‚ Status    â”‚ Batch â”‚ Ran At              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 20240110T120000_initial                     â”‚ âœ… Applied â”‚ 1     â”‚ 2024-01-10 12:00:00 â”‚
â”‚ 20240112T090000_add_users                   â”‚ âœ… Applied â”‚ 1     â”‚ 2024-01-12 09:00:00 â”‚
â”‚ 20240115T143022_add_posts_table             â”‚ âœ… Applied â”‚ 2     â”‚ 2024-01-15 14:30:22 â”‚
â”‚ 20240118T100000_add_comments                â”‚ â³ Pending â”‚ -     â”‚ -                   â”‚
â”‚ 20240120T080000_add_tags                    â”‚ â³ Pending â”‚ -     â”‚ -                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### migrate:reset

Rollback all migrations.

```bash
bun questpie migrate:reset
bun questpie migrate:reset --dry-run
```

**Options:**

| Option                | Description                                         |
| --------------------- | --------------------------------------------------- |
| `-c, --config <path>` | Path to config file (default: `questpie.config.ts`) |
| `--dry-run`           | Show what would be run without executing            |

**Warning:** This will remove all tables created by migrations. Data will be lost.

---

### migrate:fresh

Drop all tables and re-run all migrations from scratch.

```bash
bun questpie migrate:fresh
bun questpie migrate:fresh --dry-run
```

**Options:**

| Option                | Description                                         |
| --------------------- | --------------------------------------------------- |
| `-c, --config <path>` | Path to config file (default: `questpie.config.ts`) |
| `--dry-run`           | Show what would be run without executing            |

**Warning:** This will destroy all data. Use only in development.

---

## Schema Commands

### push

Push schema changes directly to the database without creating migration files. **For development only.**

```bash
bun questpie push
bun questpie push --dry-run
bun questpie push --verbose
```

**What it does:**

1. Loads your app schema via `app.getSchema()`
2. Compares with the current database schema
3. Applies changes directly to the database (no migration files created)

**Options:**

| Option                | Description                                         |
| --------------------- | --------------------------------------------------- |
| `-c, --config <path>` | Path to config file (default: `questpie.config.ts`) |
| `--dry-run`           | Preview changes without applying                    |
| `--verbose`           | Show detailed output                                |

**Example output:**

```
ğŸš€ Pushing schema changes...

ğŸ“Š Loaded schema with 12 definitions

Changes to apply:
  â€¢ Added table "comments"
  â€¢ Added column "posts"."featured"
  â€¢ Added index "posts_featured_idx"

âœ… Schema pushed successfully!
```

**When to use push vs migrate:generate:**

| Scenario                        | Command                           |
| ------------------------------- | --------------------------------- |
| Local development, prototyping  | `push`                            |
| Staging/production deployments  | `migrate:generate` + `migrate:up` |
| Team collaboration              | `migrate:generate` + `migrate:up` |
| Quick schema iteration          | `push`                            |
| Auditable change history needed | `migrate:generate` + `migrate:up` |

**Warning:** `push` modifies your database directly and does not create reversible migration files. Only use in development.

---

## Migrations Directory

The CLI saves generated migrations to `cli.migrations.directory` (default: `./src/migrations`). You can customize this in your `questpie.config.ts`:

```typescript
// questpie.config.ts
import { q } from "questpie";
import { app } from "./src/server/app";

export default q.config({
  app: app,
  cli: {
    migrations: {
      directory: "./db/migrations", // Custom directory for generated files
    },
  },
});
```

**Important:** The directory is only for storing generated migration files. Migrations are loaded at runtime via `.migrations([...])` on your app instance, not by scanning the directory.

### migrations/index.ts

The CLI automatically maintains an index file that exports all migrations:

```typescript
// migrations/index.ts
import type { Migration } from "questpie";

import { initial20240110T120000 } from "./20240110T120000_initial";
import { addUsers20240112T090000 } from "./20240112T090000_add_users";
import { addPostsTable20240115T143022 } from "./20240115T143022_add_posts_table";

export const migrations: Migration[] = [
  initial20240110T120000,
  addUsers20240112T090000,
  addPostsTable20240115T143022,
];
```

## Typical Workflow

```bash
# 1. Make schema changes in your collection definitions
# Edit src/collections/posts.ts

# 2. Generate migration
bun questpie migrate:generate --name add_featured_to_posts

# 3. Review the generated migration
# Check src/migrations/20240120T100000_add_featured_to_posts.ts

# 4. Import migrations in your app instance (if not already done)
# In src/server/app.ts:
#   import { migrations } from "../migrations";
#   export const app = q({ name: "my-app" })
#     .collections({ posts })
#     .migrations(migrations)  // <-- Add this
#     .build({ ... });

# 5. Run the migration
bun questpie migrate:up

# 6. If something goes wrong, rollback
bun questpie migrate:down
```

**Note:** Step 4 only needs to be done once. After that, the `migrations/index.ts` file is automatically updated when you generate new migrations.

## Manual Migrations

For complex changes, you can create migrations manually:

```typescript
// migrations/20240120T100000_custom_migration.ts
import type { Migration } from "questpie";
import { sql } from "drizzle-orm";

export const customMigration20240120T100000: Migration = {
  id: "20240120T100000_custom_migration",
  up: async (db) => {
    // Add column
    await db.execute(
      sql`ALTER TABLE "posts" ADD COLUMN "featured" boolean DEFAULT false`,
    );

    // Create index
    await db.execute(
      sql`CREATE INDEX "posts_featured_idx" ON "posts" ("featured")`,
    );

    // Data migration
    await db.execute(
      sql`UPDATE "posts" SET "featured" = true WHERE "view_count" > 1000`,
    );
  },
  down: async (db) => {
    await db.execute(sql`DROP INDEX IF EXISTS "posts_featured_idx"`);
    await db.execute(sql`ALTER TABLE "posts" DROP COLUMN IF EXISTS "featured"`);
  },
};
```

Then add it to `migrations/index.ts`:

```typescript
import { customMigration20240120T100000 } from "./20240120T100000_custom_migration";

export const migrations: Migration[] = [
  // ... existing migrations
  customMigration20240120T100000,
];
```

## Development Tips

### Use --dry-run for Safety

Always preview changes before running:

```bash
bun questpie migrate:generate --dry-run
bun questpie migrate:up --dry-run
```

### Fresh Start in Development

When prototyping, use `migrate:fresh` to start clean:

```bash
bun questpie migrate:fresh
bun run seed  # Re-seed your data
```

### CI/CD Pipeline

In production deployments, always run migrations:

```bash
# In your deployment script
bun questpie migrate:up
```

## Troubleshooting

### "Config file not found"

Ensure `questpie.config.ts` exists and exports your app instance using `q.config`:

```typescript
// questpie.config.ts
import { q } from "questpie";
import { app } from "./src/server/app";

export default q.config({
  app: app,
  cli: {
    migrations: {
      directory: "./src/migrations",
    },
  },
});
```

### "Migrations directory not found"

Run `migrate:generate` first to create the directory:

```bash
bun questpie migrate:generate
```

### "No schema changes detected"

If you expect changes but none are detected:

1. Check that your collection definitions have actually changed
2. Ensure the app is built with the latest schema
3. Use `--verbose` to see detailed comparison

```bash
bun questpie migrate:generate --verbose
```

### "Migration not found" when running migrate:up

Ensure you've imported the migrations in your app instance:

```typescript
// src/server/app.ts
import { migrations } from "../migrations";

export const app = q({ name: "my-app" })
  .collections({ posts })
  .migrations(migrations) // <-- Required!
  .build({ ... });
```

The CLI loads migrations from `app.config.migrations.migrations`, not by scanning the directory.

## Drizzle Kit vs QUESTPIE CLI

QUESTPIE uses its own migration system instead of Drizzle Kit directly because:

1. **Unified schema** - Collections, globals, auth tables are merged into one schema
2. **Batch tracking** - Migrations are grouped in batches for easier rollback
3. **App-aware** - Understands QUESTPIE-specific tables and relations

However, under the hood we use Drizzle's schema diffing. For more details on how Drizzle migrations work, see the [Drizzle Kit documentation](https://orm.drizzle.team/docs/kit-overview).

## Related

- [Collections](/docs/core-concepts/collections) - Define your schema
- [Fields](/docs/core-concepts/fields) - Field types reference
- [CMS Configuration](/docs/reference/cms-config) - Full config options
- [Drizzle ORM Documentation](https://orm.drizzle.team/) - Full Drizzle reference
- [Drizzle Kit Migrations](https://orm.drizzle.team/docs/migrations) - How schema diffing works
