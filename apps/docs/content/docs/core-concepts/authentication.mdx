---
title: Authentication
description: Auth integration overview
---

# Authentication

QUESTPIE CMS uses Better Auth for authentication, providing a flexible and secure auth system out of the box.

## Quick Setup

The easiest way to add authentication is using the starter module:

```typescript
import { q } from "questpie";
import { starterModule } from "questpie/server";

const cms = q({ name: "my-cms" })
  .use(starterModule)  // Adds auth collections
  .auth({
    emailAndPassword: { enabled: true },
    secret: process.env.AUTH_SECRET,
  })
  .build({
    db: { url: process.env.DATABASE_URL },
  });
```

The starter module provides these collections:

- `user` - User accounts
- `session` - Active sessions
- `account` - OAuth/social accounts
- `verification` - Email verification tokens
- `apikey` - API keys

## Authentication Methods

### Email/Password

Basic email and password authentication:

```typescript
.auth({
  emailAndPassword: { enabled: true },
  secret: process.env.AUTH_SECRET,
})
```

### OAuth Providers

Add social login:

```typescript
.auth({
  socialProviders: {
    google: {
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    },
    github: {
      clientId: process.env.GITHUB_CLIENT_ID!,
      clientSecret: process.env.GITHUB_CLIENT_SECRET!,
    },
    discord: {
      clientId: process.env.DISCORD_CLIENT_ID!,
      clientSecret: process.env.DISCORD_CLIENT_SECRET!,
    },
  },
})
```

### Session Configuration

Customize session behavior:

```typescript
.auth({
  session: {
    expiresIn: 60 * 60 * 24 * 30,  // 30 days
    updateAge: 60 * 60 * 24,        // Refresh after 1 day
    cookieCache: {
      enabled: true,
      maxAge: 60 * 5,  // 5 minutes
    },
  },
})
```

### Email Verification

Require email verification:

```typescript
.auth({
  emailVerification: {
    sendOnSignUp: true,
    sendVerificationEmail: async ({ user, url }) => {
      await cms.email.send({
        to: user.email,
        subject: "Verify your email",
        template: "verification",
        data: { url, name: user.name },
      });
    },
  },
})
```

## Using Authentication

### Server-Side

Access the auth instance and session:

```typescript
// Get current session in API route
const session = await cms.auth.api.getSession({
  headers: request.headers,
});

if (session) {
  console.log("User:", session.user);
}

// Sign in programmatically
const result = await cms.auth.api.signInEmail({
  body: {
    email: "user@example.com",
    password: "password123",
  },
});

// Sign out
await cms.auth.api.signOut({
  headers: request.headers,
});
```

### In Hooks

Access session in collection hooks:

```typescript
const posts = q.collection("posts")
  .fields({...})
  .hooks({
    beforeCreate: async ({ data, ctx }) => {
      if (!ctx.session) {
        throw new Error("Must be authenticated");
      }

      // Set author to current user
      data.authorId = ctx.session.user.id;
      return data;
    },
  });
```

### In Access Control

Use session in access rules:

```typescript
const posts = q.collection("posts")
  .access({
    read: () => true,  // Anyone can read

    create: ({ ctx }) => {
      // Must be authenticated
      return !!ctx.session;
    },

    update: ({ ctx, data }) => {
      // Author or admin can update
      if (ctx.session?.user?.role === "admin") return true;
      return data.authorId === ctx.session?.user?.id;
    },

    delete: ({ ctx }) => {
      // Only admin can delete
      return ctx.session?.user?.role === "admin";
    },
  });
```

### Client-Side

Auth endpoints are available at `/api/auth/`:

```typescript
// Sign up
await fetch("/api/auth/sign-up", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    email: "user@example.com",
    password: "password123",
    name: "John Doe",
  }),
});

// Sign in
await fetch("/api/auth/sign-in/email", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    email: "user@example.com",
    password: "password123",
  }),
  credentials: "include",  // Important: include cookies
});

// Get session
const res = await fetch("/api/auth/session", {
  credentials: "include",
});
const session = await res.json();
```

With the CMS client:

```typescript
const client = createClient<AppCMS>({
  baseURL: "http://localhost:3000",
  fetch: (url, init) => fetch(url, {
    ...init,
    credentials: "include",  // Include auth cookies
  }),
});

// Operations will use the session cookie
const posts = await client.collections.posts.find();
```

## User Roles

Implement role-based access:

### Define Roles

```typescript
// User collection already has role field
const usersCollection = collection("user")
  .fields({
    ...existingFields,
    role: varchar("role", { length: 50 }).default("user"),
  });
```

### Check Roles

```typescript
// In access control
.access({
  create: ({ ctx }) => {
    const role = ctx.session?.user?.role;
    return role === "admin" || role === "editor";
  },
})

// In hooks
.hooks({
  beforeUpdate: async ({ data, ctx }) => {
    if (ctx.session?.user?.role !== "admin") {
      // Non-admins can't change certain fields
      delete data.featured;
      delete data.sticky;
    }
    return data;
  },
})
```

## API Keys

For programmatic access without sessions:

```typescript
// Create API key (server-side)
const apiKey = await cms.api.collections.apikey.create({
  name: "CI/CD Pipeline",
  userId: systemUserId,
  permissions: JSON.stringify(["posts:read", "posts:create"]),
});

// Use API key in requests
const response = await fetch("/api/cms/posts", {
  headers: {
    "Authorization": `Bearer ${apiKey.key}`,
  },
});
```

## Better Auth Plugins

Extend with Better Auth plugins:

```typescript
import { twoFactor } from "better-auth/plugins";

.auth({
  emailAndPassword: { enabled: true },
  plugins: [
    twoFactor({
      issuer: "My App",
    }),
  ],
})
```

## Auth Routes

Better Auth creates these routes under `/api/auth/`:

| Route | Method | Description |
|-------|--------|-------------|
| `/sign-up` | POST | Create account |
| `/sign-in/email` | POST | Email sign in |
| `/sign-in/social` | GET | OAuth sign in |
| `/sign-out` | POST | Sign out |
| `/session` | GET | Get current session |
| `/verify-email` | GET | Verify email |
| `/forgot-password` | POST | Request reset |
| `/reset-password` | POST | Reset password |

## Request Context

The CMS creates a request context with session info:

```typescript
// Creating context manually
const ctx = await cms.createContext({
  session: await cms.auth.api.getSession({ headers }),
  locale: "en",
});

// Context structure
interface RequestContext {
  session?: {
    user: {
      id: string;
      email: string;
      name: string;
      role?: string;
      // ... other user fields
    };
    session: {
      id: string;
      expiresAt: Date;
      // ... session data
    };
  };
  locale: string;
  defaultLocale: string;
  accessMode: "system" | "user";
}
```

## Access Modes

Two access modes for CRUD operations:

### System Mode

Bypasses all access control:

```typescript
const ctx = await cms.createContext({
  accessMode: "system",  // Full access
});

// Used for internal operations, migrations, etc.
await cms.api.collections.posts.find({}, ctx);
```

### User Mode

Applies access control rules:

```typescript
const ctx = await cms.createContext({
  session: userSession,
  accessMode: "user",  // Apply access rules
});

// Only returns posts user has access to
await cms.api.collections.posts.find({}, ctx);
```

## Related

- [Auth Guide](/docs/guides/authentication) - Complete setup guide
- [Access Control](/docs/backend/access-control) - Permission rules
- [Context](/docs/backend/context) - Request context
