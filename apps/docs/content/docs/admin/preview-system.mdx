---
title: Preview System
description: Live preview with side-by-side editing, draft mode, and click-to-focus
---

# Preview System

QUESTPIE supports live preview - a side-by-side panel in the form view that shows how content looks on your frontend. Preview URLs are defined on the server; the admin renders the preview iframe and handles bidirectional communication.

## Why This Exists

Content editors want to see how their changes look before publishing. The preview system:
- Embeds your frontend in an iframe next to the form
- Updates the preview as fields change (debounced)
- Supports click-to-focus navigation from preview to form field
- Handles draft mode via secure tokens

## Architecture Overview

```text
┌─────────────────────────────────────────────────────────────────┐
│                        Admin Panel                               │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────┐    ┌─────────────────────────────────┐ │
│  │     Form Panel      │    │       Preview Iframe            │ │
│  │                     │    │                                 │ │
│  │  [Title: ____]      │───▶│   ┌─────────────────────────┐   │ │
│  │  [Content: ___]     │    │   │  Your Frontend Page     │   │ │
│  │  [Image: ___]       │◀───│   │  (with preview data)    │   │ │
│  │                     │    │   └─────────────────────────┘   │ │
│  └─────────────────────┘    └─────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
         │                              │
         │ postMessage                  │ postMessage
         │ (PREVIEW_REFRESH)            │ (FIELD_CLICKED)
         ▼                              ▼
```

## Server Configuration

### 1. Add `.preview()` to Collection

```ts title="collections/pages.ts"
import { qb } from "@/questpie/server/builder";

export const pages = qb
  .collection("pages")
  .fields((f) => ({
    title: f.text({ required: true, localized: true }),
    slug: f.text({ required: true }),
    content: f.blocks({ localized: true }),
    isPublished: f.boolean({ default: false }),
  }))
  .preview({
    enabled: true,
    position: "right",
    defaultWidth: 50,
    url: ({ record, locale }) => {
      const slug = record.slug as string;
      // "home" slug maps to root, others to /{slug}
      const path = slug === "home" ? "/" : `/${slug}`;
      return `${path}?preview=true${locale ? `&locale=${locale}` : ""}`;
    },
  })
  .list(({ v }) => v.table({}))
  .form(({ v, f }) => v.form({ fields: [f.title, f.slug, f.content] }));
```

### Preview Configuration Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `enabled` | `boolean` | `true` | Enable preview panel |
| `position` | `"right" \| "left" \| "bottom"` | `"right"` | Panel position relative to form |
| `defaultWidth` | `number` | `50` | Default width percentage |
| `url` | `(ctx) => string` | required | Function generating preview URL |

The `url` function receives:
- `record` - Current form values
- `locale` - Current content locale (if localized)

### 2. Create Preview API Route

The preview system uses secure tokens for draft mode. Create an API route to handle token verification:

```ts title="routes/api/preview.ts"
import { createDraftModeCookie } from "@questpie/admin/shared";
import { createPreviewTokenVerifier } from "@questpie/admin/server";
import { createFileRoute } from "@tanstack/react-router";

const verifyPreviewToken = createPreviewTokenVerifier();

export const Route = createFileRoute("/api/preview")({
  server: {
    handlers: {
      GET: async ({ request }) => {
        const url = new URL(request.url);
        const disable = url.searchParams.get("disable");

        // Handle preview disable (clear cookie)
        if (disable === "true") {
          return new Response(null, {
            status: 302,
            headers: {
              Location: "/",
              "Set-Cookie": createDraftModeCookie(false),
              "Cache-Control": "private, no-store",
            },
          });
        }

        // Handle preview enable
        const token = url.searchParams.get("token");
        if (!token) {
          return new Response("Missing token parameter", { status: 400 });
        }

        const payload = verifyPreviewToken(token);
        if (!payload) {
          return new Response("Invalid or expired preview token", { status: 401 });
        }

        // Set draft mode cookie and redirect
        return new Response(null, {
          status: 302,
          headers: {
            Location: payload.path,
            "Set-Cookie": createDraftModeCookie(true),
            "Cache-Control": "private, no-store",
          },
        });
      },
    },
  },
});
```

### 3. Set Environment Variable

Add a secret for signing preview tokens:

```bash title=".env"
SECRET=your-secure-random-string-here
# or specifically for preview:
PREVIEW_SECRET=your-preview-secret-here
```

## Frontend Integration

### Basic Integration with `useCollectionPreview`

The `useCollectionPreview` hook handles all preview communication:

```tsx title="components/PageRenderer.tsx"
import {
  BlockRenderer,
  PreviewProvider,
  useCollectionPreview,
  type BlockContent,
} from "@questpie/admin/client";
import { useRouter } from "@tanstack/react-router";

interface PageRendererProps {
  page: {
    id: string;
    title: string;
    content: BlockContent;
  };
}

export function PageRenderer({ page }: PageRendererProps) {
  const router = useRouter();

  const {
    data,                  // Reactive data (preview or initial)
    isPreviewMode,         // Whether in preview mode
    selectedBlockId,       // Currently selected block (for highlighting)
    focusedField,          // Currently focused field path
    handleFieldClick,      // Handler for field clicks
    handleBlockClick,      // Handler for block clicks
  } = useCollectionPreview({
    initialData: page,
    onRefresh: () => router.invalidate(),
  });

  return (
    <PreviewProvider
      isPreviewMode={isPreviewMode}
      focusedField={focusedField}
      onFieldClick={handleFieldClick}
    >
      <article className={isPreviewMode ? "preview-mode" : ""}>
        <h1>{data.title}</h1>
        
        {data.content && (
          <BlockRenderer
            content={data.content}
            renderers={blockRenderers}
            data={data.content._data}
            selectedBlockId={selectedBlockId}
            onBlockClick={isPreviewMode ? handleBlockClick : undefined}
          />
        )}

        {isPreviewMode && <PreviewModeIndicator />}
      </article>
    </PreviewProvider>
  );
}

function PreviewModeIndicator() {
  return (
    <div className="fixed bottom-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-full shadow-lg">
      Preview Mode - Click elements to edit
    </div>
  );
}
```

### Click-to-Focus with `PreviewField`

Wrap clickable elements with `PreviewField` for click-to-focus functionality:

```tsx title="components/BarberProfile.tsx"
import {
  PreviewProvider,
  PreviewField,
  useCollectionPreview,
} from "@questpie/admin/client";

export function BarberProfile({ barber }) {
  const {
    data,
    isPreviewMode,
    focusedField,
    handleFieldClick,
  } = useCollectionPreview({
    initialData: barber,
  });

  return (
    <PreviewProvider
      isPreviewMode={isPreviewMode}
      focusedField={focusedField}
      onFieldClick={handleFieldClick}
    >
      <div className="profile">
        {/* Clicking this focuses the "name" field in admin */}
        <PreviewField field="name" as="h1" className="text-4xl font-bold">
          {data.name}
        </PreviewField>

        {/* Clicking this focuses the "bio" field in admin */}
        <PreviewField field="bio" as="div" className="prose">
          {data.bio}
        </PreviewField>

        {/* For nested fields */}
        <PreviewField field="contact.email" as="a" href={`mailto:${data.contact?.email}`}>
          {data.contact?.email}
        </PreviewField>
      </div>
    </PreviewProvider>
  );
}
```

### Manual Integration (without hooks)

If you need more control, listen for messages directly:

```tsx
import { useEffect, useState } from "react";

export function ManualPreviewPage({ initialData }) {
  const [data, setData] = useState(initialData);
  const [isPreviewMode, setIsPreviewMode] = useState(false);

  useEffect(() => {
    const handler = (event: MessageEvent) => {
      // Verify origin in production
      if (event.data?.type === "PREVIEW_REFRESH") {
        setIsPreviewMode(true);
        // Data comes from parent iframe
      }
    };

    window.addEventListener("message", handler);
    
    // Signal that preview is ready
    window.parent?.postMessage({ type: "PREVIEW_READY" }, "*");
    
    return () => window.removeEventListener("message", handler);
  }, []);

  return <div>{/* render with data */}</div>;
}
```

## PostMessage Protocol

### Admin to Preview Messages

| Type | Description |
|------|-------------|
| `PREVIEW_REFRESH` | Data updated, re-render preview |
| `SELECT_BLOCK` | Highlight a specific block |
| `FOCUS_FIELD` | Scroll to and highlight a field |

### Preview to Admin Messages

| Type | Description |
|------|-------------|
| `PREVIEW_READY` | Preview iframe loaded and ready |
| `FIELD_CLICKED` | User clicked a field in preview |
| `BLOCK_CLICKED` | User clicked a block in preview |
| `REFRESH_COMPLETE` | Preview finished re-rendering |

## Draft Mode

The preview system uses a `__draft_mode` cookie to enable draft content:

```ts
// Check if draft mode is enabled
import { isDraftMode } from "@questpie/admin/shared";

export async function loader({ request }) {
  const cookieHeader = request.headers.get("Cookie");
  const draftMode = isDraftMode(cookieHeader);

  if (draftMode) {
    // Fetch draft/unpublished content
    return fetchDraftContent();
  } else {
    // Fetch published content only
    return fetchPublishedContent();
  }
}
```

## Token Flow

```text
1. Editor clicks "Preview" in admin
2. Admin calls mintPreviewToken RPC → gets signed JWT-like token
3. Admin opens iframe: /api/preview?token=xxx
4. Preview route verifies token, sets __draft_mode cookie
5. Preview route redirects to target path
6. Frontend detects cookie, loads draft content
7. Admin and preview communicate via postMessage
```

## Best Practices

### Preview URLs

```ts
// Good: relative, deterministic
url: ({ record }) => `/${record.slug}?preview=true`

// Good: environment-aware
url: ({ record }) => `${process.env.PUBLIC_URL}/${record.slug}?preview=true`

// Good: locale-aware
url: ({ record, locale }) => `/${locale}/${record.slug}?preview=true`

// Bad: hardcoded domain
url: ({ record }) => `https://example.com/${record.slug}` // Avoid!
```

### Performance

- Preview refreshes are debounced (300ms default)
- Keep frontend renders lightweight
- Use React.memo for expensive components
- Consider skeleton states during updates

### Security

- Always verify token signatures
- Use environment-specific secrets
- Set appropriate CORS headers for cross-origin previews
- Expire tokens (default: 1 hour)

## Common Issues

### Preview button not showing

1. Check that `.preview()` is configured on the collection
2. Verify `enabled: true` (or omit, defaults to true)
3. Ensure the `url` function is defined

### Cross-origin errors

If frontend runs on different domain:

```ts
// In your preview message handler
window.parent?.postMessage(
  { type: "PREVIEW_READY" },
  "https://your-admin-domain.com" // Specific origin, not "*"
);
```

### Draft content not loading

1. Check `__draft_mode` cookie is set
2. Verify preview API route is working
3. Ensure `SECRET` or `PREVIEW_SECRET` env var is set

## Related Pages

- [Collections](/docs/server/collections) - Server-side collection configuration
- [Blocks System](/docs/admin/blocks-system) - Block preview in page builders
- [View Registry](/docs/admin/view-registry-list-and-form) - Form view configuration
