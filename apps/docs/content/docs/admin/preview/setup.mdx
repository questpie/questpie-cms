---
title: Preview Setup Guide
description: Complete guide to setting up live preview
---

# Preview Setup Guide

This guide walks through setting up live preview for your QUESTPIE CMS collections.

## Prerequisites

- QUESTPIE CMS backend running
- Admin UI configured
- Frontend application (Next.js, TanStack Start, etc.)

## Step 1: Enable Preview on Collection

Add `.preview()` to your collection admin configuration:

```typescript
// admin/collections/pages.ts
export const pagesAdmin = builder
  .collection("pages")
  .meta({ label: "Pages", icon: FileTextIcon })
  .preview({
    url: (values) => `/pages/${values.slug || "preview"}?preview=true`,
    enabled: true,
    position: "right",
    defaultWidth: 50,
  })
  .fields(({ r }) => ({
    title: r.text({ label: "Title", required: true }),
    slug: r.text({ label: "Slug", required: true }),
    content: r.blocks({
      label: "Content",
      allowedBlocks: ["hero", "text", "gallery"],
    }),
    status: r.select({
      label: "Status",
      options: [
        { label: "Draft", value: "draft" },
        { label: "Published", value: "published" },
      ],
    }),
  }))
  .form(({ v, f }) => v.form({
    sidebar: {
      position: "left",  // Keep sidebar on left when preview is on right
      fields: [f.status, f.slug],
    },
    sections: [
      { title: "Content", fields: [f.title, f.content] },
    ],
  }));
```

## Step 2: Create Preview Route

Create a preview-aware route in your frontend:

### TanStack Start

```tsx
// routes/pages/$slug.tsx
import { createFileRoute } from "@tanstack/react-router";
import { useEffect, useState } from "react";
import { BlockRenderer } from "@questpie/admin/client";
import { blocks } from "@/questpie/admin/blocks";
import { cmsClient } from "@/lib/cms-client";

export const Route = createFileRoute("/pages/$slug")({
  loader: async ({ params, location }) => {
    const isPreview = location.search.includes("preview=true");

    // In preview mode, we don't load data - it comes from admin
    if (isPreview) {
      return { page: null, isPreview: true };
    }

    // Normal mode - load from CMS
    const page = await cmsClient.collections.pages.findOne({
      where: { slug: params.slug, status: "published" },
    });

    if (!page) {
      throw new Error("Page not found");
    }

    return { page, isPreview: false };
  },
  component: PageComponent,
});

function PageComponent() {
  const { page, isPreview } = Route.useLoaderData();

  if (isPreview) {
    return <PreviewMode />;
  }

  return <PageView page={page} />;
}

function PreviewMode() {
  const [previewData, setPreviewData] = useState(null);

  useEffect(() => {
    const handleMessage = (event: MessageEvent) => {
      // Only accept messages from parent (admin)
      if (event.data?.type === "questpie:preview:update") {
        setPreviewData(event.data.values);
      }
    };

    window.addEventListener("message", handleMessage);

    // Notify parent that preview is ready
    window.parent.postMessage({ type: "questpie:preview:ready" }, "*");

    return () => window.removeEventListener("message", handleMessage);
  }, []);

  if (!previewData) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-center">
          <div className="animate-spin h-8 w-8 border-4 border-primary border-t-transparent rounded-full mx-auto mb-4" />
          <p className="text-gray-500">Loading preview...</p>
        </div>
      </div>
    );
  }

  return <PageView page={previewData} />;
}

function PageView({ page }) {
  return (
    <main>
      <h1 className="sr-only">{page.title}</h1>
      <BlockRenderer
        blocks={page.content || []}
        registry={blocks}
      />
    </main>
  );
}
```

### Next.js

```tsx
// app/pages/[slug]/page.tsx
"use client";

import { useSearchParams } from "next/navigation";
import { useEffect, useState } from "react";
import { BlockRenderer } from "@questpie/admin/client";
import { blocks } from "@/questpie/admin/blocks";

export default function Page({ params }: { params: { slug: string } }) {
  const searchParams = useSearchParams();
  const isPreview = searchParams.get("preview") === "true";

  if (isPreview) {
    return <PreviewMode />;
  }

  return <PublishedPage slug={params.slug} />;
}

function PreviewMode() {
  const [data, setData] = useState(null);

  useEffect(() => {
    const handler = (event: MessageEvent) => {
      if (event.data?.type === "questpie:preview:update") {
        setData(event.data.values);
      }
    };

    window.addEventListener("message", handler);
    window.parent.postMessage({ type: "questpie:preview:ready" }, "*");

    return () => window.removeEventListener("message", handler);
  }, []);

  if (!data) return <div>Loading preview...</div>;

  return (
    <main>
      <BlockRenderer blocks={data.content || []} registry={blocks} />
    </main>
  );
}
```

## Step 3: Handle Preview Security

Add preview authentication to protect draft content:

```typescript
// middleware.ts
export function middleware(request: NextRequest) {
  const isPreview = request.nextUrl.searchParams.get("preview") === "true";

  if (isPreview) {
    // Only allow preview from admin origin
    const referer = request.headers.get("referer");
    const adminOrigin = process.env.ADMIN_URL || "http://localhost:3000";

    // For iframe embedding, check if request is from admin
    // In production, implement proper authentication
  }

  return NextResponse.next();
}
```

## Step 4: Configure CORS for Iframe

Ensure your frontend allows being embedded in the admin iframe:

```typescript
// next.config.js or server config
module.exports = {
  async headers() {
    return [
      {
        source: "/:path*",
        headers: [
          {
            key: "X-Frame-Options",
            value: "SAMEORIGIN",  // Or specific admin origin
          },
        ],
      },
    ];
  },
};
```

## Step 5: Style Preview Indicator

Show users they're in preview mode:

```tsx
function PreviewMode() {
  const [data, setData] = useState(null);

  // ... message handling

  return (
    <>
      {/* Preview indicator */}
      <div className="fixed top-0 left-0 right-0 bg-yellow-500 text-black text-center py-1 text-sm z-50">
        Preview Mode - Changes are not saved
      </div>

      {data ? (
        <main className="pt-8">
          <BlockRenderer blocks={data.content} registry={blocks} />
        </main>
      ) : (
        <div>Loading...</div>
      )}
    </>
  );
}
```

## Testing Preview

1. Open admin and edit a page
2. Preview panel should appear on the right
3. Make changes to fields
4. Preview should update in real-time

## Troubleshooting

### Preview Not Loading

- Check browser console for errors
- Verify URL function returns correct path
- Ensure frontend route handles `?preview=true`

### Preview Not Updating

- Verify postMessage handler is set up
- Check that message type matches: `questpie:preview:update`
- Ensure no CORS errors in console

### Styling Issues

- Check iframe CSS reset
- Verify styles are loaded in preview context
- Test responsive styles at different widths

## Related

- [Click-to-Focus](/docs/admin/preview/click-to-focus) - Click preview to focus fields
- [Block System](/docs/admin/blocks) - Create blocks for page builder
